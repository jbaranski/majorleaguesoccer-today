name: send_daily_email

on:
  schedule:
    # Runs at 5:30 AM EDT (9:30 UTC) every day
    - cron: "30 9 * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  send-email:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Check for fixtures
        id: check-fixtures
        run: |
          MATCH_COUNT=$(jq '.matches | length' client/public/matches.json)
          echo "Found $MATCH_COUNT fixtures for today"
          if [ "$MATCH_COUNT" -eq 0 ]; then
            echo "No fixtures today, skipping email send"
            echo "has_fixtures=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_fixtures=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure AWS credentials
        if: steps.check-fixtures.outputs.has_fixtures == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: MLS-Today-SendEmail-GithubAction
          retry-max-attempts: 1

      - name: Send daily email to subscribers
        if: steps.check-fixtures.outputs.has_fixtures == 'true'
        run: |
          set -euo pipefail

          # Query DynamoDB for active subscribers
          QUERY_RESULT=$(aws dynamodb query \
            --table-name EmailCollector \
            --index-name SiteIndex \
            --key-condition-expression "site = :site" \
            --filter-expression "active = :active" \
            --expression-attribute-values '{
              ":site": {"S": "mlstoday"},
              ":active": {"BOOL": true}
            }')

          # Extract subscribers from query result
          SUBSCRIBER_COUNT=$(echo "$QUERY_RESULT" | jq '.Items | length')
          echo "Found $SUBSCRIBER_COUNT active subscribers"

          # Email content
          SUBJECT="Major League Soccer Today - $(date +'%A, %B %d, %Y')"
          BASE_HTML=$(cat index.html)

          # Send individual emails to each subscriber
          echo "$QUERY_RESULT" | jq -c '.Items[]' | while read -r item; do
            email=$(echo "$item" | jq -r '.email.S')
            unsub_id=$(echo "$item" | jq -r '.unsubscribe.S')
            echo "Sending to subscriber (email hidden for privacy)"

            # Inject unsubscribe link before closing </body> tag
            UNSUB_LINK="${{ secrets.UNSUBSCRIBE_URL }}?id=${unsub_id}"
            UNSUB_HTML="<div style=\"text-align:center;margin:16px 0;font-size:12px;color:#6b7280;\"><a href=\"${UNSUB_LINK}\" style=\"color:#3b82f6;\">Unsubscribe</a></div>"
            EMAIL_HTML="${BASE_HTML//<\/body>/${UNSUB_HTML}<\/body>}"

            # Create message content using jq to handle HTML properly
            HTML_CONTENT="$(echo "$EMAIL_HTML" | jq -Rs .)"
            jq -n \
              --arg subject "$SUBJECT" \
              --argjson html "$HTML_CONTENT" \
              '{
                Simple: {
                  Subject: { Data: $subject },
                  Body: { Html: { Data: $html } }
                }
              }' > /tmp/message.json

            if aws sesv2 send-email \
              --from-email-address "MLS Today <${{ secrets.FROM_EMAIL }}>" \
              --destination "{\"ToAddresses\":[\"$email\"]}" \
              --content file:///tmp/message.json > /dev/null 2>&1; then
              echo "Email sent successfully"
            else
              echo "Failed to send email"
              exit 1
            fi

            rm -f /tmp/message.json
          done

          echo "All emails sent successfully"

