name: send_daily_email

on:
  schedule:
    # Runs at 5:30 AM EDT (9:30 UTC) every day
    - cron: "30 9 * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  send-email:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: MLS-Today-SendEmail-GithubAction
          retry-max-attempts: 1

      - name: Send daily email to SES contact list
        run: |
          set -euo pipefail

          CONTACT_LIST="${{ secrets.CONTACT_LIST_NAME }}"

          # Create default content with inline template
          SUBJECT="Major League Soccer Today - $(date +'%A, %B %d, %Y')"
          HTML_CONTENT="$(cat index.html | sed 's/"/\\"/g' | tr -d '\n')"

          cat > /tmp/default-content.json << EOF
          {
            "Template": {
              "TemplateContent": {
                "Subject": "$SUBJECT",
                "Html": "$HTML_CONTENT"
              },
              "TemplateData": "{}"
            }
          }
          EOF

          # Build recipients (no replacement content needed)
          aws sesv2 list-contacts --contact-list-name "$CONTACT_LIST" --query 'Contacts[].EmailAddress' --output json | \
          jq -c '[.[] | {Destination: {ToAddresses: [.]}}]' \
            > /tmp/recipients.json

          # Send bulk email (redirect output to avoid logging email addresses)
          if aws sesv2 send-bulk-email \
            --from-email-address "${{ secrets.FROM_EMAIL }}" \
            --default-content file:///tmp/default-content.json \
            --bulk-email-entries file:///tmp/recipients.json > /tmp/ses-response.json 2>&1; then
            echo "Bulk email sent successfully"
            # Only log success count, not email addresses
            jq -r '.BulkEmailEntryResults | length as $total | map(select(.Status == "SUCCESS")) | length as $success | "Sent to \($success)/\($total) recipients"' /tmp/ses-response.json
          else
            echo "Bulk email failed"
            # Log error count without exposing email addresses
            if [ -f /tmp/ses-response.json ]; then
              jq -r '.BulkEmailEntryResults | group_by(.Status) | map("\(.[0].Status): \(length) recipients") | .[]' /tmp/ses-response.json
            fi
            exit 1
          fi

          # Cleanup
          rm -f /tmp/default-content.json /tmp/recipients.json /tmp/ses-response.json

