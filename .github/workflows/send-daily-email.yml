name: send_daily_email

on:
  schedule:
    # Runs at 5:30 AM EDT (9:30 UTC) every day
    - cron: "30 9 * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  send-email:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: MLS-Today-SendEmail-GithubAction
          retry-max-attempts: 1

      - name: Send daily email to SES contact list
        run: |
          set -euo pipefail

          CONTACT_LIST="${{ secrets.CONTACT_LIST_NAME }}"

          # Create email content JSON with proper shell expansion
          SUBJECT="Major League Soccer Today - $(date +'%A, %B %d, %Y')"
          HTML_CONTENT="$(cat index.html | sed 's/"/\\"/g' | tr -d '\n')"

          cat > /tmp/email-content.json << EOF
          {
            "Simple": {
              "Subject": {
                "Data": "$SUBJECT",
                "Charset": "UTF-8"
              },
              "Body": {
                "Html": {
                  "Data": "$HTML_CONTENT",
                  "Charset": "UTF-8"
                }
              }
            }
          }
          EOF

          # Build recipients.json from SES contact list
          aws sesv2 list-contacts \
            --contact-list-name "$CONTACT_LIST" \
            --query "Contacts[].EmailAddress" \
            --output json | \
          jq -c '[.[] | {Destination: {ToAddresses: [.]}}]' \
            > /tmp/recipients.json

          # Send the bulk email
          aws sesv2 send-bulk-email \
            --from-email-address "${{ secrets.FROM_EMAIL }}" \
            --default-content file:///tmp/email-content.json \
            --bulk-email-entries file:///tmp/recipients.json

          # Cleanup
          rm -f /tmp/email-content.json /tmp/recipients.json
          echo "Email sent via AWS SES"

